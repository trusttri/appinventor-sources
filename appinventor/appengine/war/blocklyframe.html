<!-- Copyright Â© 2012-2016 Massachusetts Institute of Technology. All Rights Reserved. -->

<!-- The contents of a blocks editor iframe in App Inventor -->
<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="closure-library/closure/goog/base.js"></script>
    <link type="text/css" rel="stylesheet" href="media/blockly.css">
    <link type="text/css" rel="stylesheet" href="media/ai2blockly.css">
    <link type="text/css" rel="stylesheet" href="closure-library/closure/goog/css/dialog.css">
    <script type="text/javascript" src="blockly-@GUID@.js"></script>
    <style>
      html, body {
      background-color: #fff;
      height: 100%;
      margin: 0;
      padding:0;
      overflow: hidden;
    }
    .blocklySvg {
      height: 100%;
      width: 100%;
    }
    .ac-renderer {
      font: normal 13px Arial, sans-serif;
      position: absolute;
      background: #fff;
      border: 1px solid #666;
      -moz-box-shadow: 2px 2px 2px rgba(102, 102, 102, .4);
      -webkit-box-shadow: 2px 2px 2px rgba(102, 102, 102, .4);
      width: 300px;
      height: 294px;
      overflow: auto;
    }
    .ac-row {
      cursor: pointer;
      padding: .4em;
    }
    .ac-highlighted {
      font-weight: bold;
    }
    .ac-active {
      background-color: #b2b4bf;
    }
    #ai_type_block {
      position: absolute;
    }
    </style>

    <script type="text/javascript">
      function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)')
                .exec(window.parent.location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
      }
      function init() {
        // We expect window.location.hash to have the form:
        // projectId_formName, and to be unique among
        // all the Blockly instances created in this App Inventor session.
        var formName = window.location.hash.substr(1);
        Blockly.BlocklyEditor.formName = formName;
        if (!window.parent.Blocklies) {
          // We keep a set of Blockly objects indexed by name
          // of the form for which they are the blocks editor
          window.parent.Blocklies = {};
        }
        window.parent.Blocklies[formName] = Blockly;
        Blockly.ReplMgr.formName = formName; <!-- So we can tell the AssetManager which form we are on. -->
        if (window.parent.ReplState === undefined) {
          window.parent.ReplState = new Blockly.ReplStateObj(); // There should be one of these for the whole system
        }
        window.parent.ReplState.phoneState = {}; <!-- Reset the phone state when we are reloaded -->
        Blockly.BlocklyEditor.prestart();  // Initialize the workspace object without generating DOM elements
        // Tell populateTypes the projectId, which is in the top
        // window's hash
        Blockly.ComponentTypes.populateTypes(top.location.hash.substr(1));
        // Verify blocks after init in case of extensions
        Blockly.Component.verifyAllBlocks();

        // If Blockly is slow to load, the BlocklyPanel will set
        // DeferredBlocklyInit to a callback function to be evaluated
        // once Blocklies is created above.
        if (typeof window.parent.DeferredBlocklyInit === "function") {
          var callbackResult = window.parent.DeferredBlocklyInit();
          if (callbackResult) {
            // Initialized successfully
            delete window.parent.DeferredBlocklyInit;
          }
        }
        window.parent.BlocklyPanel_initBlocksArea(formName);
      }
      Blockly.init = function(completion) {
        var formName = window.location.hash.substr(1);
        Blockly.BlocklyEditor.startup(document.body, formName);
        var callback = function() {
          var width;  // Not used in LTR.
          var workspace = Blockly.mainWorkspace;
          if (workspace.RTL) {
            width = workspace.getWidth();
          }
          Blockly.mainWorkspace.rendered = true;
          Blockly.getMainWorkspace().addWarningIndicator();
          Blockly.getMainWorkspace().addBackpack();
          window.parent.BlocklyPanel_checkWarningState(formName);
          var blocks = Blockly.mainWorkspace.getAllBlocks();
          for (var i = blocks.length - 1; i >= 0; i--) {
            var block = blocks[i];
            block.initSvg();
            if (!isNaN(block.x) && !isNaN(block.y)) {
              block.moveBy(workspace.RTL ? width - block.x : block.x, block.y);
            }
          }
          Blockly.BlocklyEditor.render();
          completion();
        };
        if (document.readyState != "complete") {
          document.addEventListener('DOMContentLoaded', callback);
        } else {
          callback();
        }
      }
    </script>
  </head>
  <body id="ai_frame" onload="init()">
    <div id="ai_type_block" style="display:none">
      <p>
        <input id="ac_input_text" />
      </p>
    </div>
  </body>
</html>
